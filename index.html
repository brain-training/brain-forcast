<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãŸã¾ã®å¤©æ°—äºˆå ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* ç”»é¢å…¨ä½“ã‚’ã‚³ãƒ³ãƒ†ãƒŠã®èƒŒæ™¯è‰²ã§æŸ“ã‚ã‚‹ */
        html, body {
            height: 100%;
            margin: 0;
            background-color: #f0f4f8; /* Light blue-gray background */
            overflow: hidden; /* Prevent scrolling */
        }
        /* ã‚¢ãƒ—ãƒªã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å¤©åœ°ä¸­å¤®ã«é…ç½® */
        .app-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆï¼ˆãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰ã®ç”»é¢ã‚’æ¨¡å€£ */
        .tablet-screen {
            width: 100%;
            height: 100%;
            max-width: 1024px;
            max-height: 768px;
            background-color: white;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            padding-bottom: 40px;
        }
        .step-card {
            display: none; /* Initially hide all cards */
            animation: fadeIn 0.5s;
        }
        .step-card.active {
            display: flex; /* Show active card */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .keyboard-key {
            transition: all 0.1s ease-in-out;
        }
        .keyboard-key:active {
            transform: scale(0.95);
            background-color: #d1d5db;
        }
        .option-button {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .option-button.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #2563eb;
            font-weight: 600;
        }
        /* Custom scrollbar for content if needed */
        .content-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .content-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .content-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .content-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Responsive adjustments for smaller tablets / portrait mode */
        @media (max-width: 768px), (max-height: 720px) {
            /* Reduce vertical spacing in main content area */
            main {
                padding: 1rem;
            }

            /* Reduce font sizes for labels and inputs */
            .step-card h2.text-3xl, .step-card h2.text-2xl, .step-card label.text-2xl {
                font-size: 1.125rem; /* text-lg */
                margin-bottom: 0.5rem;
            }
            .step-card input.text-4xl, input[id$="-input"].text-4xl {
                font-size: 1.5rem; /* text-2xl */
                padding: 0.5rem;
            }
            .step-card p.text-gray-500 {
                font-size: 0.75rem; /* text-xs */
                margin-bottom: 0.5rem;
            }
            .step-card .text-lg {
                font-size: 0.875rem; /* text-sm */
            }

            /* Reduce hiragana keyboard size */
            #hiragana-keyboard {
                gap: 0.2rem;
                padding-left: 0;
                padding-right: 0;
            }
            #hiragana-keyboard .keyboard-key {
                height: 2rem; /* h-8 */
                font-size: 0.875rem; /* text-sm */
            }

            /* Reduce number keyboard size */
            #number-keyboard-age, div[id^="keyboard-"] {
                margin-top: 1rem;
            }
            #number-keyboard-age .flex.gap-4, div[id^="keyboard-"] .flex.gap-4 {
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }
            #number-keyboard-age .keyboard-key, div[id^="keyboard-"] .keyboard-key {
                height: 3rem; /* h-12 */
                font-size: 1.25rem; /* text-xl */
            }
            
            /* Reduce options button size */
            .option-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem; /* text-sm */
            }
            
            /* Reduce footer and header button size */
            footer#navigation-footer button, button.text-2xl {
                padding: 0.5rem 1.5rem;
                font-size: 0.875rem; /* text-sm */
            }
            footer#navigation-footer {
                padding: 0.5rem;
            }

            /* Adjust spacing on specific keyboard pages */
            #step-1 .mb-4, #step-2 .mb-4, div[id^="step-"] .mb-4 {
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="tablet-screen">
            <!-- Header -->
            <header class="p-4 border-b bg-gray-50">
                <h1 class="text-xl font-bold text-gray-700 text-center">ã‚ãŸã¾ã®å¤©æ°—äºˆå ±</h1>
                <p class="text-xs text-gray-500 text-center mt-1">æ ªå¼ä¼šç¤¾D&Pãƒ¡ãƒ‡ã‚£ã‚¢ åƒè‘‰å¤§å­¦æºä¸Šç ”ç©¶å®¤ å…ªç ”ç©¶å®¤</p>
            </header>

            <!-- Progress Bar -->
            <div id="progress-container" class="w-full bg-gray-200 h-2.5 hidden">
                <div id="progress-bar" class="bg-blue-500 h-2.5" style="width: 0%; transition: width 0.3s ease;"></div>
            </div>
            
            <main class="flex-grow flex flex-col p-6 md:p-10 overflow-hidden">
                <!-- Step Container -->
                <div id="steps-container" class="flex-grow flex flex-col justify-center">

                    <!-- Step 0: Start -->
                    <div id="step-0" class="step-card active flex-col items-center justify-center text-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®é–‹å§‹</h2>
                        <p class="text-lg text-gray-600 mb-8 max-w-md">æº–å‚™ãŒã§ãã¾ã—ãŸã‚‰ã€ã€Œå§‹ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
                        <button onclick="navigate(1)" class="w-full max-w-xs bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-lg text-2xl transition">å§‹ã‚ã‚‹</button>
                    </div>

                    <!-- Step 1: Name -->
                    <div id="step-1" class="step-card flex-col items-center justify-center h-full">
                        <div class="w-full text-center mb-4">
                            <label class="text-2xl font-semibold text-gray-700">ãŠåå‰ã‚’ã²ã‚‰ãŒãªã§å…¥åŠ›ã—ã¦ãã ã•ã„</label>
                            <p class="text-gray-500 mb-4">ä¾‹: ã™ãšã ã„ã¡ã‚ã†</p>
                            <input type="text" id="name-input" readonly class="w-full max-w-lg mx-auto text-4xl p-4 text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›">
                        </div>
                        <div id="hiragana-keyboard" class="w-full max-w-3xl mx-auto px-4"></div>
                    </div>

                    <!-- Step 2: Age -->
                    <div id="step-2" class="step-card flex-col items-center justify-center h-full">
                        <div class="w-full text-center">
                            <label class="text-2xl font-semibold text-gray-700">å¹´é½¢(æ­³)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
                            <p class="text-gray-500 mb-4">ä¾‹: 75</p>
                            <div class="relative w-full max-w-sm mx-auto">
                                <input type="text" id="age-input" readonly class="w-full text-4xl p-4 text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›">
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl text-gray-500">æ­³</span>
                            </div>
                        </div>
                        <div id="number-keyboard-age" class="w-full max-w-md mx-auto mt-6"></div>
                    </div>

                    <!-- Other steps will be dynamically generated by JS -->

                    <!-- Step Final: Result -->
                     <div id="step-final" class="step-card flex-col items-center justify-center text-center">
                         <h2 class="text-3xl font-bold text-gray-800 mb-4">è¨ºæ–­çµæœ</h2>
                         <div class="bg-blue-50 border-2 border-blue-200 p-8 rounded-2xl w-full max-w-lg">
                             <p class="text-lg text-gray-600 mb-2">ã‚ãªãŸã®5å¹´å¾Œã®èªçŸ¥ç—‡ç™ºç—‡ãƒªã‚¹ã‚¯ã¯</p>
                             <p id="risk-percentage" class="text-6xl font-bold text-blue-600 my-4 min-h-[80px] flex items-center justify-center"></p>
                             <p id="risk-comment" class="text-lg text-gray-700 mt-4 px-4"></p>
                             <p class="text-sm text-gray-500 mt-6">* ã“ã®çµæœã¯ã‚ãã¾ã§ç›®å®‰ã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
                         </div>
                         <div class="flex space-x-4 mt-8 w-full max-w-lg">
                             <button onclick="location.href='https://sppchecker.github.io/'">SPPè‰²è¦šãƒã‚§ãƒƒã‚¯</button>
                             <!--
                             <button onclick="saveResults()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition">çµæœã‚’ä¿å­˜</button>
                             <button onclick="sendResults()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition">çµæœã‚’é€ä¿¡</button>
                             -->
                             
                         </div>
                     </div>
                </div>
            </main>

            <!-- Footer Navigation -->
            <footer id="navigation-footer" class="p-4 border-t flex justify-between items-center bg-gray-50 hidden">
                <button onclick="navigate(-1)" id="prev-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-10 rounded-lg text-xl transition">æˆ»ã‚‹</button>
                <div id="progress-text" class="text-lg font-medium text-gray-600"></div>
                <button onclick="navigate(1)" id="next-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-10 rounded-lg text-xl transition">æ¬¡ã¸</button>
            </footer>
        </div>
    </div>

<script>
    // --- State Management ---
    let currentStep = 0;
    const formData = {};

    const questions = [
        { id: 'start', type: 'start' },
        { id: 'name', type: 'keyboard', keyboard: 'hiragana' },
        { id: 'age', type: 'keyboard', keyboard: 'number' },
        { id: 'gender', title: 'æ€§åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„', options: [
            { text: 'ç”·æ€§', score: 1 }, 
            { text: 'å¥³æ€§', score: 0 }, 
            { text: 'å›ç­”ã—ãªã„', score: 0 }
        ]},
        { id: 'smoking', title: 'å–«ç…™ã®æœ‰ç„¡ã‚’é¸æŠã—ã¦ãã ã•ã„', options: [
            { text: 'å–«ç…™ä¸­', score: 2 }, 
            { text: 'éå»ã«å–«ç…™', score: 1 }, 
            { text: 'å–«ç…™ã—ãªã„', score: 0 }
        ]},
        { id: 'alcohol', title: 'é£²é…’ã®é »åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„', options: [
            { text: 'æ¯æ—¥', score: 2 }, 
            { text: 'é€±ã«æ•°å›ç¨‹åº¦', score: 1 }, 
            { text: 'ã»ã¨ã‚“ã©é£²ã¾ãªã„', score: 0 },
            { text: 'é£²ã¾ãªã„', score: 0 }
        ]},
        { id: 'height', type: 'keyboard', keyboard: 'number', label: 'èº«é•·(cm)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', example: 'ä¾‹: 160' },
        { id: 'weight', type: 'keyboard', keyboard: 'number', label: 'ä½“é‡(kg)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', example: 'ä¾‹: 65' },
        { id: 'bmi', type: 'calculation', calculate: calculateBMI, title: 'ã‚ãªãŸã®BMIã¯' },
        { id: 'systolic_bp', title: 'é«˜è¡€åœ§ã®æœ‰ç„¡(å¹³å¸¸æ™‚ã®æœ€é«˜è¡€åœ§)', options: [
            { text: '140ä»¥ä¸Š', score: 3 }, // Changed: score 2 -> 3
            { text: '130-139', score: 1 },
            { text: '130æœªæº€', score: 0 }
        ]},
        { id: 'diastolic_bp', title: 'é«˜è¡€åœ§ã®æœ‰ç„¡(å¹³å¸¸æ™‚ã®æœ€ä½è¡€åœ§)', options: [
            { text: '90ä»¥ä¸Š', score: 2 },
            { text: '80-89', score: 1 },
            { text: '80æœªæº€', score: 0 }
        ]},
        { id: 'exercise', title: 'é‹å‹•ã®é »åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„', options: [
            { text: 'æ¯æ—¥', score: 0 },
            { text: 'é€±ã«2-3æ—¥', score: 0 },
            { text: 'æœˆã«1æ—¥ç¨‹åº¦', score: 1 },
            { text: 'å…¨ãè¡Œã£ã¦ã„ãªã„', score: 3 } // Changed: score 2 -> 3
        ]},
        { id: 'diabetes', title: 'ç³–å°¿ç—…ã®æœ‰ç„¡ã‚’é¸æŠã—ã¦ãã ã•ã„', options: [
            { text: 'ã‚ã‚Š', score: 2 },
            { text: 'ãªã—', score: 0 },
            { text: 'æ²»ç™‚ä¸­', score: 1 }
        ]},
        { id: 'family_history', title: 'ã”å®¶æ—ã«èªçŸ¥ç—‡ã®æ–¹ãŒã„ã¾ã™(ã„ã¾ã—ãŸ)ã‹', options: [
            { text: 'ã¯ã„', score: 4 }, // Changed: score 3 -> 4
            { text: 'ã„ã„ãˆ', score: 0 }
        ]},
        { id: 'family_history_who', type: 'keyboard', keyboard: 'hiragana', label: 'ã©ãªãŸãŒèªçŸ¥ç—‡ã§ã—ãŸã‹ï¼Ÿ (ä¾‹: æ¯)', example: '' },
        { id: 'education', title: 'æœ€çµ‚å­¦æ­´ã‚’é¸æŠã—ã¦ãã ã•ã„', options: [
            { text: 'å°ãƒ»ä¸­å­¦å’', score: 2 },
            { text: 'é«˜å’', score: 1 },
            { text: 'å¤§å’', score: 0 },
            { text: 'å¤§å­¦é™¢å’', score: 0 }
        ]},
        { id: 'hearing', title: 'ç¾åœ¨ã®è´åŠ›ã®çŠ¶æ…‹ã‚’é¸æŠã—ã¦ãã ã•ã„', options: [
            { text: 'æ­£å¸¸', score: 0 },
            { text: 'è»½åº¦é›£è´', score: 1 },
            { text: 'ä¸­ç¨‹åº¦é›£è´', score: 2 },
            { text: 'é‡åº¦é›£è´', score: 3 }
        ]},
        { id: 'social', title: 'ç¤¾ä¼šæ´»å‹•ã®é »åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„', options: [
            { text: 'æ¯æ—¥', score: 0 },
            { text: 'é€±2å›ç¨‹åº¦', score: 1 },
            { text: 'æœˆæ•°å›', score: 2 },
            { text: 'ã»ã¨ã‚“ã©ç„¡ã„', score: 3 }
        ]},
        { id: 'sleep', title: 'ç¡çœ ã®è³ªã¯ã„ã‹ãŒã§ã™ã‹', options: [
            { text: 'è‰¯å¥½', score: 0 },
            { text: 'ã‚„ã‚„ä¸è‰¯', score: 1 },
            { text: 'ä¸è‰¯', score: 2 },
            { text: 'éå¸¸ã«ä¸è‰¯', score: 3 }
        ]},
        { id: 'cognitive', title: 'èªçŸ¥æ´»å‹•(èª­æ›¸ãƒ»ãƒ‘ã‚ºãƒ«ç­‰)ã®é »åº¦', options: [
            { text: 'æ¯æ—¥', score: 0 },
            { text: 'é€±ã«2-3å›', score: 1 },
            { text: 'æœˆæ•°å›', score: 2 },
            { text: 'ã»ã¨ã‚“ã©ã—ãªã„', score: 3 }
        ]},
        { id: 'depression', title: 'æŠ‘ã†ã¤ç—‡çŠ¶ã®æœ‰ç„¡ã‚’é¸æŠã—ã¦ãã ã•ã„', options: [
            { text: 'ã‚ã‚Š', score: 2 },
            { text: 'ãªã—', score: 0 }
        ]},
        { id: 'final', type: 'final' }
    ];
    const totalQuestions = questions.filter(q => q.type !== 'start' && q.type !== 'final' && q.type !== 'calculation' && q.id !== 'family_history_who').length;

    // --- Keyboard Definitions ---
    const hiraganaLayout = [
        [
            ['ã‚', 'ã‚‰', 'ã‚„', 'ã¾', 'ã¯', 'ãª', 'ãŸ', 'ã•', 'ã‹', 'ã‚'],
            ['', 'ã‚Š', '', 'ã¿', 'ã²', 'ã«', 'ã¡', 'ã—', 'ã', 'ã„'],
            ['ã‚’', 'ã‚‹', 'ã‚†', 'ã‚€', 'ãµ', 'ã¬', 'ã¤', 'ã™', 'ã', 'ã†'],
            ['', 'ã‚Œ', '', 'ã‚', 'ã¸', 'ã­', 'ã¦', 'ã›', 'ã‘', 'ãˆ'],
            ['ã‚“', 'ã‚', 'ã‚ˆ', 'ã‚‚', 'ã»', 'ã®', 'ã¨', 'ã', 'ã“', 'ãŠ'],
        ],
        // Special keys and their column spans
        [['ã‚›', 1], ['ã‚œ', 1], ['å°', 1], ['ã‚¹ãƒšãƒ¼ã‚¹', 4], ['ã‘ã™', 3]]
    ];
    
    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        generateQuestionCards();
        createKeyboard('hiragana-keyboard', hiraganaLayout, document.getElementById('name-input'));
        createKeyboard('number-keyboard-age', [
            ['1', '2', '3'], ['4', '5', '6'], ['7', '8', '9'], ['ã‘ã™', '0', '.']
        ], document.getElementById('age-input'), 'number_large');
        showStep(0);
    });

    // --- UI Generation ---
    function generateQuestionCards() {
        const container = document.getElementById('steps-container');
        questions.forEach((q, index) => {
            if (q.type === 'start' || q.id === 'name' || q.id === 'age' || q.type === 'final') return;
            const stepDiv = document.createElement('div');
            stepDiv.id = `step-${index}`;
            stepDiv.className = 'step-card flex-col items-center justify-center';
            container.appendChild(stepDiv);

            let cardHTML = '';
            if (q.type === 'keyboard') {
                cardHTML = `
                    <div class="flex flex-col items-center justify-center h-full w-full">
                        <div class="w-full text-center mb-4">
                            <label class="text-2xl font-semibold text-gray-700">${q.label}</label>
                            <p class="text-gray-500 mb-4">${q.example}</p>
                            <div class="relative w-full max-w-lg mx-auto">
                                <input type="text" id="${q.id}-input" readonly class="w-full text-4xl p-4 text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›">
                                ${q.id === 'height' ? '<span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl text-gray-500">cm</span>' : ''}
                                ${q.id === 'weight' ? '<span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl text-gray-500">kg</span>' : ''}
                            </div>
                        </div>
                        <div id="keyboard-${q.id}" class="w-full max-w-3xl mx-auto px-4"></div>
                    </div>`;
                stepDiv.innerHTML = cardHTML;
                if (q.keyboard === 'hiragana') {
                    createKeyboard(`keyboard-${q.id}`, hiraganaLayout, document.getElementById(`${q.id}-input`));
                } else {
                    createKeyboard(`keyboard-${q.id}`, [
                        ['1', '2', '3'], ['4', '5', '6'], ['7', '8', '9'], ['ã‘ã™', '0', '.']
                    ], document.getElementById(`${q.id}-input`), 'number_large');
                }
            } else if (q.type === 'calculation') {
                 cardHTML = `<div class="text-center">
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">${q.title}</h2>
                            <div class="bg-gray-50 border-2 border-gray-200 p-8 rounded-2xl w-full max-w-md">
                                <p id="${q.id}-result-text" class="text-6xl font-bold text-gray-800"></p>
                                <p id="${q.id}-result-subtext" class="text-xl text-gray-600 mt-2"></p>
                            </div></div>`;
                 stepDiv.innerHTML = cardHTML;
            } else { // Options
                 cardHTML = `<div class="text-center w-full">
                            <h2 class="text-2xl font-semibold text-gray-700 mb-6">${q.title}</h2>
                            <div class="grid grid-cols-1 gap-4 w-full max-w-md mx-auto">
                                ${q.options.map((opt, i) => `<button onclick="selectOption('${q.id}', '${opt.text}', this)" class="option-button bg-white text-gray-700 font-semibold py-6 px-4 border border-gray-300 rounded-lg text-xl shadow-sm hover:bg-gray-50">${i+1}. ${opt.text}</button>`).join('')}
                            </div></div>`;
                 stepDiv.innerHTML = cardHTML;
            }
        });
        container.appendChild(document.getElementById('step-final'));
    }

    function createKeyboard(containerId, layout, inputElement, type = 'hiragana') {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = ''; // Clear previous content

        if (type === 'number_large') {
             container.innerHTML = layout.map(row => `
                <div class="flex justify-center gap-4 mb-4">
                    ${row.map(key => {
                        if (key === '') return '<div class="flex-1"></div>';
                        return `<button data-key="${key}" class="keyboard-key flex-1 h-24 text-4xl font-semibold bg-white rounded-lg shadow border border-gray-300">${key}</button>`
                    }).join('')}
                </div>
            `).join('');
        } else { // hiragana
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(10, 1fr)';
            container.style.gap = '0.5rem';

            const mainKeys = layout[0];
            const specialKeys = layout[1];

            // Render main characters
            mainKeys.flat().forEach(key => {
                const el = document.createElement('div');
                el.className = 'flex items-center justify-center';
                if (key !== '') {
                    const button = document.createElement('button');
                    button.dataset.key = key;
                    button.className = 'keyboard-key w-full h-12 text-xl bg-white rounded-lg shadow border border-gray-300';
                    button.textContent = key;
                    el.appendChild(button);
                }
                container.appendChild(el);
            });
            
            // Render special keys with correct column spans
            specialKeys.forEach(keyInfo => {
                const key = keyInfo[0];
                const span = keyInfo[1];
                const button = document.createElement('button');
                button.dataset.key = key;
                button.textContent = key;
                button.className = 'keyboard-key h-12 text-xl bg-white rounded-lg shadow border border-gray-300';
                button.style.gridColumn = `span ${span}`;
                container.appendChild(button);
            });
        }

        container.addEventListener('click', (e) => {
            const button = e.target.closest('.keyboard-key');
            if (button) {
                const key = button.dataset.key;
                if (key === 'ã‘ã™') {
                    inputElement.value = inputElement.value.slice(0, -1);
                } else if (key === 'ã‚¹ãƒšãƒ¼ã‚¹') {
                    inputElement.value += ' ';
                } else {
                    inputElement.value += key;
                }
            }
        });
    }

    // --- Navigation and State Logic ---
    function getNextStepIndex(currentIndex) {
        const currentQuestion = questions[currentIndex];
        if (currentQuestion.id === 'family_history' && formData.family_history !== 'ã¯ã„') {
            return questions.findIndex(q => q.id === 'education');
        }
        if ((currentIndex + 1) < questions.length) return currentIndex + 1;
        return currentIndex;
    }

    function getPrevStepIndex(currentIndex) {
        const prevIndex = currentIndex - 1;
        if(prevIndex < 0) return 0;
        const prevQuestion = questions[prevIndex];
        if (prevQuestion.id === 'family_history_who' && formData.family_history !== 'ã¯ã„') {
            return prevIndex - 1;
        }
        return prevIndex;
    }

    function navigate(direction) {
        const currentQuestion = questions[currentStep];
        if (direction > 0 && currentQuestion.type === 'keyboard') {
             const input = document.getElementById(`${currentQuestion.id}-input`);
             if(input) formData[currentQuestion.id] = input.value;
        }

        if (direction > 0 && !validateStep(currentStep)) {
            const inputEl = document.getElementById(`${currentQuestion.id}-input`);
            if (inputEl) {
                inputEl.classList.add('border-red-500');
                setTimeout(() => inputEl.classList.remove('border-red-500'), 2000);
            }
            return;
        }
        
        const nextStepIndex = direction > 0 ? getNextStepIndex(currentStep) : getPrevStepIndex(currentStep);
        const nextQuestion = questions[nextStepIndex];
        if (nextQuestion && nextQuestion.type === 'calculation') nextQuestion.calculate();
        if (nextQuestion && nextQuestion.type === 'final') calculateRiskScore();

        showStep(nextStepIndex);
    }

    function showStep(index) {
        // Deactivate the previous step by determining its correct ID
        const prevQuestionData = questions[currentStep];
        const prevStepId = (prevQuestionData && prevQuestionData.type === 'final') ? 'step-final' : `step-${currentStep}`;
        document.getElementById(prevStepId)?.classList.remove('active');

        currentStep = index;
        const questionData = questions[currentStep];
        
        // Determine the ID of the current step card, handling the special 'step-final' ID
        const currentStepId = (questionData.type === 'final') ? 'step-final' : `step-${currentStep}`;
        const stepElement = document.getElementById(currentStepId);
        
        let questionProgressIndex = questions
            .filter(q => q.type !== 'start' && q.type !== 'final' && q.type !== 'calculation' && q.id !== 'family_history_who')
            .findIndex(q => q.id === questionData.id) + 1;

        if (stepElement) {
            stepElement.classList.add('active');
            const isStart = currentStep === 0;
            const isFinal = (questionData.type === 'final');
            document.getElementById('navigation-footer').classList.toggle('hidden', isStart || isFinal);
            document.getElementById('progress-container').classList.toggle('hidden', isStart || isFinal);

            if (!isStart && !isFinal) {
                const progress = (questionProgressIndex / totalQuestions) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${questionProgressIndex} / ${totalQuestions}`;
            }
            document.getElementById('prev-btn').disabled = (currentStep <= 1);
            document.getElementById('prev-btn').classList.toggle('opacity-50', currentStep <= 1);
        }
    }
    
    function validateStep(index) {
        const question = questions[index];
        if (!question) return false;
        if(question.type === 'keyboard') {
            const input = document.getElementById(`${question.id}-input`);
            return input && input.value.trim() !== '';
        } else if (question.options) {
             return formData.hasOwnProperty(question.id);
        }
        return true;
    }

    function selectOption(key, value, element) {
        formData[key] = value;
        const options = element.parentElement.querySelectorAll('.option-button');
        options.forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');

        if (key === 'family_history' && value === 'ã¯ã„') {
             const whoIndex = questions.findIndex(q => q.id === 'family_history_who');
             setTimeout(() => showStep(whoIndex), 300);
        } else {
            setTimeout(() => navigate(1), 300);
        }
    }
    
    function calculateBMI() {
        const height = parseFloat(formData.height);
        const weight = parseFloat(formData.weight);
        if (height > 0 && weight > 0) {
            const heightInMeters = height / 100;
            const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
            formData.bmiValue = parseFloat(bmi);
            let category = '';
            if (bmi < 18.5) category = 'ä½ä½“é‡';
            else if (bmi < 25) category = 'æ™®é€šä½“é‡';
            else if (bmi < 30) category = 'è‚¥æº€(1åº¦)';
            else if (bmi < 35) category = 'è‚¥æº€(2åº¦)';
            else if (bmi < 40) category = 'è‚¥æº€(3åº¦)';
            else category = 'è‚¥æº€(4åº¦)';
            document.getElementById('bmi-result-text').textContent = bmi;
            document.getElementById('bmi-result-subtext').textContent = category;
        } else {
             document.getElementById('bmi-result-text').textContent = 'ã‚¨ãƒ©ãƒ¼';
             document.getElementById('bmi-result-subtext').textContent = 'èº«é•·ã¨ä½“é‡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„';
        }
    }

    function calculateRiskScore() {
        const riskPercentageEl = document.getElementById('risk-percentage');
        const riskCommentEl = document.getElementById('risk-comment');

        // 1. Set loading state immediately
        riskPercentageEl.innerHTML = `<div class="text-3xl font-semibold text-gray-500">è¨ˆç®—ä¸­...</div>`;
        riskCommentEl.textContent = 'ã‚ãªãŸã®ç”Ÿæ´»ç¿’æ…£ã‚„å¥åº·çŠ¶æ…‹ã‚’åˆ†æã—ã¦ã„ã¾ã™ã€‚';

        // 2. Wait for 1 second before calculating and showing results
        setTimeout(() => {
            let score = 0;
            const age = parseInt(formData.age, 10);
            if (age >= 85) score += 6;
            else if (age >= 75) score += 4;
            else if (age >= 65) score += 2;

            const bmi = formData.bmiValue;
            if (bmi < 18.5) score += 1;
            else if (bmi >= 30) score += 2;
            else if (bmi >= 25) score += 1;

            for (const key in formData) {
                const question = questions.find(q => q.id === key);
                if (question && question.options) {
                    const selectedOption = question.options.find(opt => opt.text === formData[key]);
                    if (selectedOption) score += selectedOption.score;
                }
            }
            
            // This calculation is an illustrative model and not a medical diagnosis.
            // The formula converts the weighted score into a plausible 5-year risk percentage.
            let riskPercent = (score * 0.9) + 0.5;
            riskPercent = Math.min(Math.max(riskPercent, 0.5), 60.0); // Cap the risk percentage
            
            // Update the UI with the final result
            riskPercentageEl.textContent = `${riskPercent.toFixed(1)}%`;

            let comment = '';
            if (riskPercent < 5.0) {
                comment = "ç¾åœ¨ã®5å¹´å¾Œã®ç™ºç—‡ãƒªã‚¹ã‚¯ã¯ä½ã„çŠ¶æ…‹ã§ã™ã€‚ã“ã®ã¾ã¾å¥åº·çš„ãªç”Ÿæ´»ç¿’æ…£ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚";
            } else if (riskPercent < 15.0) {
                comment = "ã„ãã¤ã‹æ³¨æ„ã™ã¹ãç‚¹ãŒã‚ã‚Šã¾ã™ã€‚é£Ÿç”Ÿæ´»ã‚„é‹å‹•ç¿’æ…£ãªã©ã€ç”Ÿæ´»ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã™ã‚‹ã“ã¨ã§ã€å°†æ¥ã®ãƒªã‚¹ã‚¯ã‚’ä¸‹ã’ã‚‹ã“ã¨ãŒæœŸå¾…ã§ãã¾ã™ã€‚";
            } else {
                comment = "ãƒªã‚¹ã‚¯ãŒã‚„ã‚„é«˜ã„å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚ã“ã®çµæœã‚’æ©Ÿã«ã€ç”Ÿæ´»ç¿’æ…£ã®æ”¹å–„ã«ç©æ¥µçš„ã«å–ã‚Šçµ„ã¿ã€å¿…è¦ã§ã‚ã‚Œã°å°‚é–€å®¶ã¸ã®ç›¸è«‡ã‚‚ã”æ¤œè¨ãã ã•ã„ã€‚";
            }
            riskCommentEl.textContent = comment;
        }, 1000); // 1-second delay
        sendResults();
    }

    function saveResults() {
        console.log("çµæœã‚’ä¿å­˜:", formData);
        // This is a placeholder. In a real app, you would use File System Access API or send to a server.
        alert("çµæœãŒã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚ï¼ˆé–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªã§ãã¾ã™ï¼‰");
    }

    function sendResults() {
        console.log("çµæœã‚’é€ä¿¡:", formData);
        
        // ãƒ•ã‚©ãƒ¼ãƒ åã‚’å–å¾—
        const formName = getFormName();
        
        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç”¨ã®é…åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const dataArray = createKeyValueData();
        
        // Google Apps Scriptã«ãƒ•ã‚©ãƒ¼ãƒ åã¨ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        sendToGoogleSpreadsheet(formName, dataArray);
    }

    function createKeyValueData() {
        // BMIè¨ˆç®—ï¼ˆä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤ã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°è¨ˆç®—ï¼‰
        let bmiValue = formData.bmiValue;
        if (!bmiValue && formData.height && formData.weight) {
            const height = parseFloat(formData.height) / 100;
            const weight = parseFloat(formData.weight);
            bmiValue = (weight / (height * height)).toFixed(1);
        }
        
        // 5å¹´å¾Œã®èªçŸ¥ç—‡ç™ºç—‡ãƒªã‚¹ã‚¯ã‚’è¨ˆç®—
        let riskPercent = calculateRiskPercentage();
        
        // é…åˆ—å½¢å¼ã§key, label, valueã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        // timestampã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•æŒ¿å…¥ã•ã‚Œã‚‹ãŸã‚é™¤å¤–
        const dataArray = [
            { key: 'name', label: 'æ°å', value: formData.name || '' },
            { key: 'age', label: 'å¹´é½¢', value: formData.age || '' },
            { key: 'gender', label: 'æ€§åˆ¥', value: formData.gender || '' },
            { key: 'smoking', label: 'å–«ç…™ã®æœ‰ç„¡', value: formData.smoking || '' },
            { key: 'alcohol', label: 'é£²é…’ã®æœ‰ç„¡', value: formData.alcohol || '' },
            { key: 'height', label: 'èº«é•·', value: formData.height || '' },
            { key: 'weight', label: 'ä½“é‡', value: formData.weight || '' },
            { key: 'bmi', label: 'BMIè¨ˆç®—çµæœ', value: new String(bmiValue) || '' },
            { key: 'systolic_bp', label: 'é«˜è¡€åœ§ã®æœ‰ç„¡ï¼ˆå¹³å¸¸æ™‚ã®æœ€é«˜è¡€åœ§ï¼‰', value: formData.systolic_bp || '' },
            { key: 'diastolic_bp', label: 'é«˜è¡€åœ§ã®æœ‰ç„¡ï¼ˆå¹³å¸¸æ™‚ã®æœ€ä½è¡€åœ§ï¼‰', value: formData.diastolic_bp || '' },
            { key: 'exercise', label: 'é‹å‹•ã®é »åº¦', value: formData.exercise || '' },
            { key: 'diabetes', label: 'ç³–å°¿ç—…ã®æœ‰ç„¡', value: formData.diabetes || '' },
            { key: 'family_history', label: 'å®¶æ—ã«èªçŸ¥ç—‡ã®æ–¹ãŒã„ã‚‹ï¼ˆã„ãŸï¼‰', value: formData.family_history || '' },
            { key: 'family_history_who', label: 'èªçŸ¥ç—‡ã®å®¶æ—ï¼ˆã©ãªãŸï¼‰', value: formData.family_history_who || 'ãªã—' },
            { key: 'education', label: 'å­¦æ­´', value: formData.education || '' },
            { key: 'hearing', label: 'ç¾åœ¨ã®è´åŠ›ã®çŠ¶æ…‹', value: formData.hearing || '' },
            { key: 'social', label: 'ç¤¾ä¼šæ´»å‹•ï¼ˆé€±ã‚ãŸã‚Šï¼‰', value: formData.social || '' },
            { key: 'sleep', label: 'ç¡çœ ã®è³ª', value: formData.sleep || '' },
            { key: 'cognitive', label: 'èªçŸ¥æ´»å‹•ï¼ˆèª­æ›¸ãƒ»ãƒ‘ã‚ºãƒ«ç­‰ï¼‰', value: formData.cognitive || '' },
            { key: 'depression', label: 'æŠ‘ã†ã¤ç—‡çŠ¶ã®æœ‰ç„¡', value: formData.depression || '' },
            { key: 'risk_percentage', label: '5å¹´å¾Œã®èªçŸ¥ç—‡ç™ºç—‡ãƒªã‚¹ã‚¯', value: `${riskPercent}%` }
        ];
        
        console.log('é…åˆ—å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿:', dataArray);
        return dataArray;
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ åã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getFormName() {
        // curlã®ä¾‹ã«åˆã‚ã›ã¦ãƒ•ã‚©ãƒ¼ãƒ åã‚’è¨­å®š
        return 'ã‚ãŸã¾ã®å¤©æ°—äºˆå ±';
    }

    function calculateRiskPercentage() {
        let score = 0;
        const age = parseInt(formData.age, 10);
        if (age >= 85) score += 6;
        else if (age >= 75) score += 4;
        else if (age >= 65) score += 2;

        const bmi = formData.bmiValue || 0;
        if (bmi < 18.5) score += 1;
        else if (bmi >= 30) score += 2;
        else if (bmi >= 25) score += 1;

        for (const key in formData) {
            const question = questions.find(q => q.id === key);
            if (question && question.options) {
                const selectedOption = question.options.find(opt => opt.text === formData[key]);
                if (selectedOption) score += selectedOption.score;
            }
        }
        
        let riskPercent = (score * 0.9) + 0.5;
        riskPercent = Math.min(Math.max(riskPercent, 0.5), 60.0);
        
        return riskPercent.toFixed(1);
    }

    async function sendToGoogleSpreadsheet(formName, dataArray) {
        // Google Apps Script Web Appã®URL
        const googleScriptURL = 'https://script.google.com/macros/s/AKfycbwamCcOjRaYG11Z_Pn9ZJP-ySE5CN1T9IIOBeCPOWJ6sii8TFfko1o_ZTljGrpMd6m0/exec';
        
        // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        console.log('=== ãƒ‡ãƒ¼ã‚¿é€ä¿¡é–‹å§‹ ===');
        console.log('ãƒ•ã‚©ãƒ¼ãƒ å:', formName);
        console.log('é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿é…åˆ—:', dataArray);
        console.log('é€ä¿¡URL:', googleScriptURL);
        
        try {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            showLoadingMessage('ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™...');
            
            const requestData = {
                action: 'addData',
                formName: formName,
                data: dataArray
            };
            
            console.log('é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:', JSON.stringify(requestData, null, 2));
            
            const response = await fetch(googleScriptURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(requestData)
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('=== ãƒ‡ãƒ¼ã‚¿é€ä¿¡æˆåŠŸ ===');
                console.log('ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
                if (result.success) {
                    let message = `âœ… è¨ºæ–­çµæœã‚’æ­£å¸¸ã«é€ä¿¡ã—ã¾ã—ãŸï¼\n\n`;
                    message += `ğŸ“Š ãƒ•ã‚©ãƒ¼ãƒ å: ${result.formName}\n`;
                    message += `ğŸ“‹ ã‚·ãƒ¼ãƒˆå: ${result.sheetName}\n`;
                    message += `ğŸ“ è¡Œç•ªå·: ${result.rowNumber}\n`;
                    message += `ğŸ“ˆ ç·åˆ—æ•°: ${result.totalColumns}\n`;
                    message += `â° é€ä¿¡æ™‚åˆ»: ${result.serverTimestamp}`;
                    
                    if (result.newColumns && result.newColumns.length > 0) {
                        message += `\n\nğŸ†• æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸé …ç›®: ${result.newColumns.length}å€‹`;
                        result.newColumns.forEach(col => {
                            message += `\n   â€¢ ${col.label} (${col.key})`;
                        });
                    }
                    
                    message += `\n\nğŸ“ é€ä¿¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿é …ç›®æ•°: ${dataArray.length}å€‹`;
                    message += `\nğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚`;
                    
                    alert(message);
                } else {
                    throw new Error(result.message || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('=== ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼ ===');
            console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            console.error('é€ä¿¡å…ˆURL:', googleScriptURL);
            console.error('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', dataArray);
            alert(`âŒ ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}\n\nğŸ”§ å¯¾å‡¦æ–¹æ³•:\nâ€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„\nâ€¢ Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„\nâ€¢ ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„`);
        } finally {
            hideLoadingMessage();
        }
    }

    function showLoadingMessage(message) {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼‰
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-message';
        loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        loadingDiv.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span class="text-lg font-medium">${message}</span>
                </div>
            </div>
        `;
        document.body.appendChild(loadingDiv);
    }

    function hideLoadingMessage() {
        const loadingDiv = document.getElementById('loading-message');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
    }

</script>

</body>
</html>
