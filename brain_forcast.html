<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>あたまの天気予報</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* 画面全体をコンテナの背景色で染める */
        html, body {
            height: 100%;
            margin: 0;
            background-color: #f0f4f8; /* Light blue-gray background */
            overflow: hidden; /* Prevent scrolling */
        }
        /* アプリのコンテナを天地中央に配置 */
        .app-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        /* タブレット（ランドスケープ）の画面を模倣 */
        .tablet-screen {
            width: 100%;
            height: 100%;
            max-width: 1024px;
            max-height: 768px;
            background-color: white;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .step-card {
            display: none; /* Initially hide all cards */
            animation: fadeIn 0.5s;
        }
        .step-card.active {
            display: flex; /* Show active card */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .keyboard-key {
            transition: all 0.1s ease-in-out;
        }
        .keyboard-key:active {
            transform: scale(0.95);
            background-color: #d1d5db;
        }
        .option-button {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .option-button.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #2563eb;
            font-weight: 600;
        }
        /* Custom scrollbar for content if needed */
        .content-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .content-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .content-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .content-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Responsive adjustments for smaller tablets / portrait mode */
        @media (max-width: 768px), (max-height: 720px) {
            /* Reduce vertical spacing in main content area */
            main {
                padding: 1rem;
            }

            /* Reduce font sizes for labels and inputs */
            .step-card h2.text-3xl, .step-card h2.text-2xl, .step-card label.text-2xl {
                font-size: 1.125rem; /* text-lg */
                margin-bottom: 0.5rem;
            }
            .step-card input.text-4xl, input[id$="-input"].text-4xl {
                font-size: 1.5rem; /* text-2xl */
                padding: 0.5rem;
            }
            .step-card p.text-gray-500 {
                font-size: 0.75rem; /* text-xs */
                margin-bottom: 0.5rem;
            }
            .step-card .text-lg {
                font-size: 0.875rem; /* text-sm */
            }

            /* Reduce hiragana keyboard size */
            #hiragana-keyboard {
                gap: 0.2rem;
                padding-left: 0;
                padding-right: 0;
            }
            #hiragana-keyboard .keyboard-key {
                height: 2rem; /* h-8 */
                font-size: 0.875rem; /* text-sm */
            }

            /* Reduce number keyboard size */
            #number-keyboard-age, div[id^="keyboard-"] {
                margin-top: 1rem;
            }
            #number-keyboard-age .flex.gap-4, div[id^="keyboard-"] .flex.gap-4 {
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }
            #number-keyboard-age .keyboard-key, div[id^="keyboard-"] .keyboard-key {
                height: 3rem; /* h-12 */
                font-size: 1.25rem; /* text-xl */
            }
            
            /* Reduce options button size */
            .option-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem; /* text-sm */
            }
            
            /* Reduce footer and header button size */
            footer#navigation-footer button, button.text-2xl {
                padding: 0.5rem 1.5rem;
                font-size: 0.875rem; /* text-sm */
            }
            footer#navigation-footer {
                padding: 0.5rem;
            }

            /* Adjust spacing on specific keyboard pages */
            #step-1 .mb-4, #step-2 .mb-4, div[id^="step-"] .mb-4 {
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="tablet-screen">
            <!-- Header -->
            <header class="p-4 border-b bg-gray-50">
                <h1 class="text-xl font-bold text-gray-700 text-center">あたまの天気予報</h1>
                <p class="text-xs text-gray-500 text-center mt-1">株式会社D&Pメディア 千葉大学溝上研究室 兪研究室</p>
            </header>

            <!-- Progress Bar -->
            <div id="progress-container" class="w-full bg-gray-200 h-2.5 hidden">
                <div id="progress-bar" class="bg-blue-500 h-2.5" style="width: 0%; transition: width 0.3s ease;"></div>
            </div>
            
            <main class="flex-grow flex flex-col p-6 md:p-10 overflow-hidden">
                <!-- Step Container -->
                <div id="steps-container" class="flex-grow flex flex-col justify-center">

                    <!-- Step 0: Start -->
                    <div id="step-0" class="step-card active flex-col items-center justify-center text-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">アンケートの開始</h2>
                        <p class="text-lg text-gray-600 mb-8 max-w-md">準備ができましたら、「始める」ボタンを押してアンケートを開始してください。</p>
                        <button onclick="navigate(1)" class="w-full max-w-xs bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-lg text-2xl transition">始める</button>
                    </div>

                    <!-- Step 1: Name -->
                    <div id="step-1" class="step-card flex-col items-center justify-center h-full">
                        <div class="w-full text-center mb-4">
                            <label class="text-2xl font-semibold text-gray-700">お名前をひらがなで入力してください</label>
                            <p class="text-gray-500 mb-4">例: すずき いちろう</p>
                            <input type="text" id="name-input" readonly class="w-full max-w-lg mx-auto text-4xl p-4 text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="タップして入力">
                        </div>
                        <div id="hiragana-keyboard" class="w-full max-w-3xl mx-auto px-4"></div>
                    </div>

                    <!-- Step 2: Age -->
                    <div id="step-2" class="step-card flex-col items-center justify-center h-full">
                        <div class="w-full text-center">
                            <label class="text-2xl font-semibold text-gray-700">年齢(歳)を入力してください</label>
                            <p class="text-gray-500 mb-4">例: 75</p>
                            <div class="relative w-full max-w-sm mx-auto">
                                <input type="text" id="age-input" readonly class="w-full text-4xl p-4 text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="タップして入力">
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl text-gray-500">歳</span>
                            </div>
                        </div>
                        <div id="number-keyboard-age" class="w-full max-w-md mx-auto mt-6"></div>
                    </div>

                    <!-- Other steps will be dynamically generated by JS -->

                    <!-- Step Final: Result -->
                     <div id="step-final" class="step-card flex-col items-center justify-center text-center">
                         <h2 class="text-3xl font-bold text-gray-800 mb-4">診断結果</h2>
                         <div class="bg-blue-50 border-2 border-blue-200 p-8 rounded-2xl w-full max-w-lg">
                             <p class="text-lg text-gray-600 mb-2">あなたの5年後の認知症発症リスクは</p>
                             <p id="risk-percentage" class="text-6xl font-bold text-blue-600 my-4 min-h-[80px] flex items-center justify-center"></p>
                             <p id="risk-comment" class="text-lg text-gray-700 mt-4 px-4"></p>
                             <p class="text-sm text-gray-500 mt-6">* この結果はあくまで目安としてご利用ください。</p>
                         </div>
                         <!--
                         <div class="flex space-x-4 mt-8 w-full max-w-lg">
                             <button onclick="saveResults()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition">結果を保存</button>
                             <button onclick="sendResults()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition">結果を送信</button>
                         </div>
                         -->
                     </div>
                </div>
            </main>

            <!-- Footer Navigation -->
            <footer id="navigation-footer" class="p-4 border-t flex justify-between items-center bg-gray-50 hidden">
                <button onclick="navigate(-1)" id="prev-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-10 rounded-lg text-xl transition">戻る</button>
                <div id="progress-text" class="text-lg font-medium text-gray-600"></div>
                <button onclick="navigate(1)" id="next-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-10 rounded-lg text-xl transition">次へ</button>
            </footer>
        </div>
    </div>

<script>
    // --- State Management ---
    let currentStep = 0;
    const formData = {};

    const questions = [
        { id: 'start', type: 'start' },
        { id: 'name', type: 'keyboard', keyboard: 'hiragana' },
        { id: 'age', type: 'keyboard', keyboard: 'number' },
        { id: 'gender', title: '性別を選択してください', options: [
            { text: '男性', score: 1 }, 
            { text: '女性', score: 0 }, 
            { text: '回答しない', score: 0 }
        ]},
        { id: 'smoking', title: '喫煙の有無を選択してください', options: [
            { text: '喫煙中', score: 2 }, 
            { text: '過去に喫煙', score: 1 }, 
            { text: '喫煙しない', score: 0 }
        ]},
        { id: 'alcohol', title: '飲酒の頻度を選択してください', options: [
            { text: '毎日', score: 2 }, 
            { text: '週に数回程度', score: 1 }, 
            { text: 'ほとんど飲まない', score: 0 },
            { text: '飲まない', score: 0 }
        ]},
        { id: 'height', type: 'keyboard', keyboard: 'number', label: '身長(cm)を入力してください', example: '例: 160' },
        { id: 'weight', type: 'keyboard', keyboard: 'number', label: '体重(kg)を入力してください', example: '例: 65' },
        { id: 'bmi', type: 'calculation', calculate: calculateBMI, title: 'あなたのBMIは' },
        { id: 'systolic_bp', title: '高血圧の有無(平常時の最高血圧)', options: [
            { text: '140以上', score: 3 }, // Changed: score 2 -> 3
            { text: '130-139', score: 1 },
            { text: '130未満', score: 0 }
        ]},
        { id: 'diastolic_bp', title: '高血圧の有無(平常時の最低血圧)', options: [
            { text: '90以上', score: 2 },
            { text: '80-89', score: 1 },
            { text: '80未満', score: 0 }
        ]},
        { id: 'exercise', title: '運動の頻度を選択してください', options: [
            { text: '毎日', score: 0 },
            { text: '週に2-3日', score: 0 },
            { text: '月に1日程度', score: 1 },
            { text: '全く行っていない', score: 3 } // Changed: score 2 -> 3
        ]},
        { id: 'diabetes', title: '糖尿病の有無を選択してください', options: [
            { text: 'あり', score: 2 },
            { text: 'なし', score: 0 },
            { text: '治療中', score: 1 }
        ]},
        { id: 'family_history', title: 'ご家族に認知症の方がいます(いました)か', options: [
            { text: 'はい', score: 4 }, // Changed: score 3 -> 4
            { text: 'いいえ', score: 0 }
        ]},
        { id: 'family_history_who', type: 'keyboard', keyboard: 'hiragana', label: 'どなたが認知症でしたか？ (例: 母)', example: '' },
        { id: 'education', title: '最終学歴を選択してください', options: [
            { text: '小・中学卒', score: 2 },
            { text: '高卒', score: 1 },
            { text: '大卒', score: 0 },
            { text: '大学院卒', score: 0 }
        ]},
        { id: 'hearing', title: '現在の聴力の状態を選択してください', options: [
            { text: '正常', score: 0 },
            { text: '軽度難聴', score: 1 },
            { text: '中程度難聴', score: 2 },
            { text: '重度難聴', score: 3 }
        ]},
        { id: 'social', title: '社会活動の頻度を選択してください', options: [
            { text: '毎日', score: 0 },
            { text: '週2回程度', score: 1 },
            { text: '月数回', score: 2 },
            { text: 'ほとんど無い', score: 3 }
        ]},
        { id: 'sleep', title: '睡眠の質はいかがですか', options: [
            { text: '良好', score: 0 },
            { text: 'やや不良', score: 1 },
            { text: '不良', score: 2 },
            { text: '非常に不良', score: 3 }
        ]},
        { id: 'cognitive', title: '認知活動(読書・パズル等)の頻度', options: [
            { text: '毎日', score: 0 },
            { text: '週に2-3回', score: 1 },
            { text: '月数回', score: 2 },
            { text: 'ほとんどしない', score: 3 }
        ]},
        { id: 'depression', title: '抑うつ症状の有無を選択してください', options: [
            { text: 'あり', score: 2 },
            { text: 'なし', score: 0 }
        ]},
        { id: 'final', type: 'final' }
    ];
    const totalQuestions = questions.filter(q => q.type !== 'start' && q.type !== 'final' && q.type !== 'calculation' && q.id !== 'family_history_who').length;

    // --- Keyboard Definitions ---
    const hiraganaLayout = [
        [
            ['わ', 'ら', 'や', 'ま', 'は', 'な', 'た', 'さ', 'か', 'あ'],
            ['', 'り', '', 'み', 'ひ', 'に', 'ち', 'し', 'き', 'い'],
            ['を', 'る', 'ゆ', 'む', 'ふ', 'ぬ', 'つ', 'す', 'く', 'う'],
            ['', 'れ', '', 'め', 'へ', 'ね', 'て', 'せ', 'け', 'え'],
            ['ん', 'ろ', 'よ', 'も', 'ほ', 'の', 'と', 'そ', 'こ', 'お'],
        ],
        // Special keys and their column spans
        [['゛', 1], ['゜', 1], ['小', 1], ['スペース', 4], ['けす', 3]]
    ];
    
    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        generateQuestionCards();
        createKeyboard('hiragana-keyboard', hiraganaLayout, document.getElementById('name-input'));
        createKeyboard('number-keyboard-age', [
            ['1', '2', '3'], ['4', '5', '6'], ['7', '8', '9'], ['けす', '0', '.']
        ], document.getElementById('age-input'), 'number_large');
        showStep(0);
    });

    // --- UI Generation ---
    function generateQuestionCards() {
        const container = document.getElementById('steps-container');
        questions.forEach((q, index) => {
            if (q.type === 'start' || q.id === 'name' || q.id === 'age' || q.type === 'final') return;
            const stepDiv = document.createElement('div');
            stepDiv.id = `step-${index}`;
            stepDiv.className = 'step-card flex-col items-center justify-center';
            container.appendChild(stepDiv);

            let cardHTML = '';
            if (q.type === 'keyboard') {
                cardHTML = `
                    <div class="flex flex-col items-center justify-center h-full w-full">
                        <div class="w-full text-center mb-4">
                            <label class="text-2xl font-semibold text-gray-700">${q.label}</label>
                            <p class="text-gray-500 mb-4">${q.example}</p>
                            <div class="relative w-full max-w-lg mx-auto">
                                <input type="text" id="${q.id}-input" readonly class="w-full text-4xl p-4 text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="タップして入力">
                                ${q.id === 'height' ? '<span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl text-gray-500">cm</span>' : ''}
                                ${q.id === 'weight' ? '<span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl text-gray-500">kg</span>' : ''}
                            </div>
                        </div>
                        <div id="keyboard-${q.id}" class="w-full max-w-3xl mx-auto px-4"></div>
                    </div>`;
                stepDiv.innerHTML = cardHTML;
                if (q.keyboard === 'hiragana') {
                    createKeyboard(`keyboard-${q.id}`, hiraganaLayout, document.getElementById(`${q.id}-input`));
                } else {
                    createKeyboard(`keyboard-${q.id}`, [
                        ['1', '2', '3'], ['4', '5', '6'], ['7', '8', '9'], ['けす', '0', '.']
                    ], document.getElementById(`${q.id}-input`), 'number_large');
                }
            } else if (q.type === 'calculation') {
                 cardHTML = `<div class="text-center">
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">${q.title}</h2>
                            <div class="bg-gray-50 border-2 border-gray-200 p-8 rounded-2xl w-full max-w-md">
                                <p id="${q.id}-result-text" class="text-6xl font-bold text-gray-800"></p>
                                <p id="${q.id}-result-subtext" class="text-xl text-gray-600 mt-2"></p>
                            </div></div>`;
                 stepDiv.innerHTML = cardHTML;
            } else { // Options
                 cardHTML = `<div class="text-center w-full">
                            <h2 class="text-2xl font-semibold text-gray-700 mb-6">${q.title}</h2>
                            <div class="grid grid-cols-1 gap-4 w-full max-w-md mx-auto">
                                ${q.options.map((opt, i) => `<button onclick="selectOption('${q.id}', '${opt.text}', this)" class="option-button bg-white text-gray-700 font-semibold py-6 px-4 border border-gray-300 rounded-lg text-xl shadow-sm hover:bg-gray-50">${i+1}. ${opt.text}</button>`).join('')}
                            </div></div>`;
                 stepDiv.innerHTML = cardHTML;
            }
        });
        container.appendChild(document.getElementById('step-final'));
    }

    function createKeyboard(containerId, layout, inputElement, type = 'hiragana') {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = ''; // Clear previous content

        if (type === 'number_large') {
             container.innerHTML = layout.map(row => `
                <div class="flex justify-center gap-4 mb-4">
                    ${row.map(key => {
                        if (key === '') return '<div class="flex-1"></div>';
                        return `<button data-key="${key}" class="keyboard-key flex-1 h-24 text-4xl font-semibold bg-white rounded-lg shadow border border-gray-300">${key}</button>`
                    }).join('')}
                </div>
            `).join('');
        } else { // hiragana
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(10, 1fr)';
            container.style.gap = '0.5rem';

            const mainKeys = layout[0];
            const specialKeys = layout[1];

            // Render main characters
            mainKeys.flat().forEach(key => {
                const el = document.createElement('div');
                el.className = 'flex items-center justify-center';
                if (key !== '') {
                    const button = document.createElement('button');
                    button.dataset.key = key;
                    button.className = 'keyboard-key w-full h-12 text-xl bg-white rounded-lg shadow border border-gray-300';
                    button.textContent = key;
                    el.appendChild(button);
                }
                container.appendChild(el);
            });
            
            // Render special keys with correct column spans
            specialKeys.forEach(keyInfo => {
                const key = keyInfo[0];
                const span = keyInfo[1];
                const button = document.createElement('button');
                button.dataset.key = key;
                button.textContent = key;
                button.className = 'keyboard-key h-12 text-xl bg-white rounded-lg shadow border border-gray-300';
                button.style.gridColumn = `span ${span}`;
                container.appendChild(button);
            });
        }

        container.addEventListener('click', (e) => {
            const button = e.target.closest('.keyboard-key');
            if (button) {
                const key = button.dataset.key;
                if (key === 'けす') {
                    inputElement.value = inputElement.value.slice(0, -1);
                } else if (key === 'スペース') {
                    inputElement.value += ' ';
                } else {
                    inputElement.value += key;
                }
            }
        });
    }

    // --- Navigation and State Logic ---
    function getNextStepIndex(currentIndex) {
        const currentQuestion = questions[currentIndex];
        if (currentQuestion.id === 'family_history' && formData.family_history !== 'はい') {
            return questions.findIndex(q => q.id === 'education');
        }
        if ((currentIndex + 1) < questions.length) return currentIndex + 1;
        return currentIndex;
    }

    function getPrevStepIndex(currentIndex) {
        const prevIndex = currentIndex - 1;
        if(prevIndex < 0) return 0;
        const prevQuestion = questions[prevIndex];
        if (prevQuestion.id === 'family_history_who' && formData.family_history !== 'はい') {
            return prevIndex - 1;
        }
        return prevIndex;
    }

    function navigate(direction) {
        const currentQuestion = questions[currentStep];
        if (direction > 0 && currentQuestion.type === 'keyboard') {
             const input = document.getElementById(`${currentQuestion.id}-input`);
             if(input) formData[currentQuestion.id] = input.value;
        }

        if (direction > 0 && !validateStep(currentStep)) {
            const inputEl = document.getElementById(`${currentQuestion.id}-input`);
            if (inputEl) {
                inputEl.classList.add('border-red-500');
                setTimeout(() => inputEl.classList.remove('border-red-500'), 2000);
            }
            return;
        }
        
        const nextStepIndex = direction > 0 ? getNextStepIndex(currentStep) : getPrevStepIndex(currentStep);
        const nextQuestion = questions[nextStepIndex];
        if (nextQuestion && nextQuestion.type === 'calculation') nextQuestion.calculate();
        if (nextQuestion && nextQuestion.type === 'final') calculateRiskScore();

        showStep(nextStepIndex);
    }

    function showStep(index) {
        // Deactivate the previous step by determining its correct ID
        const prevQuestionData = questions[currentStep];
        const prevStepId = (prevQuestionData && prevQuestionData.type === 'final') ? 'step-final' : `step-${currentStep}`;
        document.getElementById(prevStepId)?.classList.remove('active');

        currentStep = index;
        const questionData = questions[currentStep];
        
        // Determine the ID of the current step card, handling the special 'step-final' ID
        const currentStepId = (questionData.type === 'final') ? 'step-final' : `step-${currentStep}`;
        const stepElement = document.getElementById(currentStepId);
        
        let questionProgressIndex = questions
            .filter(q => q.type !== 'start' && q.type !== 'final' && q.type !== 'calculation' && q.id !== 'family_history_who')
            .findIndex(q => q.id === questionData.id) + 1;

        if (stepElement) {
            stepElement.classList.add('active');
            const isStart = currentStep === 0;
            const isFinal = (questionData.type === 'final');
            document.getElementById('navigation-footer').classList.toggle('hidden', isStart || isFinal);
            document.getElementById('progress-container').classList.toggle('hidden', isStart || isFinal);

            if (!isStart && !isFinal) {
                const progress = (questionProgressIndex / totalQuestions) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${questionProgressIndex} / ${totalQuestions}`;
            }
            document.getElementById('prev-btn').disabled = (currentStep <= 1);
            document.getElementById('prev-btn').classList.toggle('opacity-50', currentStep <= 1);
        }
    }
    
    function validateStep(index) {
        const question = questions[index];
        if (!question) return false;
        if(question.type === 'keyboard') {
            const input = document.getElementById(`${question.id}-input`);
            return input && input.value.trim() !== '';
        } else if (question.options) {
             return formData.hasOwnProperty(question.id);
        }
        return true;
    }

    function selectOption(key, value, element) {
        formData[key] = value;
        const options = element.parentElement.querySelectorAll('.option-button');
        options.forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');

        if (key === 'family_history' && value === 'はい') {
             const whoIndex = questions.findIndex(q => q.id === 'family_history_who');
             setTimeout(() => showStep(whoIndex), 300);
        } else {
            setTimeout(() => navigate(1), 300);
        }
    }
    
    function calculateBMI() {
        const height = parseFloat(formData.height);
        const weight = parseFloat(formData.weight);
        if (height > 0 && weight > 0) {
            const heightInMeters = height / 100;
            const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
            formData.bmiValue = parseFloat(bmi);
            let category = '';
            if (bmi < 18.5) category = '低体重';
            else if (bmi < 25) category = '普通体重';
            else if (bmi < 30) category = '肥満(1度)';
            else if (bmi < 35) category = '肥満(2度)';
            else if (bmi < 40) category = '肥満(3度)';
            else category = '肥満(4度)';
            document.getElementById('bmi-result-text').textContent = bmi;
            document.getElementById('bmi-result-subtext').textContent = category;
        } else {
             document.getElementById('bmi-result-text').textContent = 'エラー';
             document.getElementById('bmi-result-subtext').textContent = '身長と体重を正しく入力してください';
        }
    }

    function calculateRiskScore() {
        const riskPercentageEl = document.getElementById('risk-percentage');
        const riskCommentEl = document.getElementById('risk-comment');

        // 1. Set loading state immediately
        riskPercentageEl.innerHTML = `<div class="text-3xl font-semibold text-gray-500">計算中...</div>`;
        riskCommentEl.textContent = 'あなたの生活習慣や健康状態を分析しています。';

        // 2. Wait for 1 second before calculating and showing results
        setTimeout(() => {
            let score = 0;
            const age = parseInt(formData.age, 10);
            if (age >= 85) score += 6;
            else if (age >= 75) score += 4;
            else if (age >= 65) score += 2;

            const bmi = formData.bmiValue;
            if (bmi < 18.5) score += 1;
            else if (bmi >= 30) score += 2;
            else if (bmi >= 25) score += 1;

            for (const key in formData) {
                const question = questions.find(q => q.id === key);
                if (question && question.options) {
                    const selectedOption = question.options.find(opt => opt.text === formData[key]);
                    if (selectedOption) score += selectedOption.score;
                }
            }
            
            // This calculation is an illustrative model and not a medical diagnosis.
            // The formula converts the weighted score into a plausible 5-year risk percentage.
            let riskPercent = (score * 0.9) + 0.5;
            riskPercent = Math.min(Math.max(riskPercent, 0.5), 60.0); // Cap the risk percentage
            
            // Update the UI with the final result
            riskPercentageEl.textContent = `${riskPercent.toFixed(1)}%`;

            let comment = '';
            if (riskPercent < 5.0) {
                comment = "現在の5年後の発症リスクは低い状態です。このまま健康的な生活習慣を続けましょう。";
            } else if (riskPercent < 15.0) {
                comment = "いくつか注意すべき点があります。食生活や運動習慣など、生活の見直しを検討することで、将来のリスクを下げることが期待できます。";
            } else {
                comment = "リスクがやや高い傾向にあります。この結果を機に、生活習慣の改善に積極的に取り組み、必要であれば専門家への相談もご検討ください。";
            }
            riskCommentEl.textContent = comment;
        }, 1000); // 1-second delay
        sendResults();
    }

    function saveResults() {
        console.log("結果を保存:", formData);
        // This is a placeholder. In a real app, you would use File System Access API or send to a server.
        alert("結果がコンソールに保存されました。（開発者ツールで確認できます）");
    }

    function sendResults() {
        console.log("結果を送信:", formData);
        
        // フォーム名を取得
        const formName = getFormName();
        
        // Googleスプレッドシート用の配列データを作成
        const dataArray = createKeyValueData();
        
        // Google Apps Scriptにフォーム名とデータを送信
        sendToGoogleSpreadsheet(formName, dataArray);
    }

    function createKeyValueData() {
        // BMI計算（保存されている値を使用、なければ計算）
        let bmiValue = formData.bmiValue;
        if (!bmiValue && formData.height && formData.weight) {
            const height = parseFloat(formData.height) / 100;
            const weight = parseFloat(formData.weight);
            bmiValue = (weight / (height * height)).toFixed(1);
        }
        
        // 5年後の認知症発症リスクを計算
        let riskPercent = calculateRiskPercentage();
        
        // 配列形式でkey, label, valueを含むデータを作成
        // timestampはサーバー側で自動挿入されるため除外
        const dataArray = [
            { key: 'name', label: '氏名', value: formData.name || '' },
            { key: 'age', label: '年齢', value: formData.age || '' },
            { key: 'gender', label: '性別', value: formData.gender || '' },
            { key: 'smoking', label: '喫煙の有無', value: formData.smoking || '' },
            { key: 'alcohol', label: '飲酒の有無', value: formData.alcohol || '' },
            { key: 'height', label: '身長', value: formData.height || '' },
            { key: 'weight', label: '体重', value: formData.weight || '' },
            { key: 'bmi', label: 'BMI計算結果', value: new String(bmiValue) || '' },
            { key: 'systolic_bp', label: '高血圧の有無（平常時の最高血圧）', value: formData.systolic_bp || '' },
            { key: 'diastolic_bp', label: '高血圧の有無（平常時の最低血圧）', value: formData.diastolic_bp || '' },
            { key: 'exercise', label: '運動の頻度', value: formData.exercise || '' },
            { key: 'diabetes', label: '糖尿病の有無', value: formData.diabetes || '' },
            { key: 'family_history', label: '家族に認知症の方がいる（いた）', value: formData.family_history || '' },
            { key: 'family_history_who', label: '認知症の家族（どなた）', value: formData.family_history_who || 'なし' },
            { key: 'education', label: '学歴', value: formData.education || '' },
            { key: 'hearing', label: '現在の聴力の状態', value: formData.hearing || '' },
            { key: 'social', label: '社会活動（週あたり）', value: formData.social || '' },
            { key: 'sleep', label: '睡眠の質', value: formData.sleep || '' },
            { key: 'cognitive', label: '認知活動（読書・パズル等）', value: formData.cognitive || '' },
            { key: 'depression', label: '抑うつ症状の有無', value: formData.depression || '' },
            { key: 'risk_percentage', label: '5年後の認知症発症リスク', value: `${riskPercent}%` }
        ];
        
        console.log('配列形式のデータ:', dataArray);
        return dataArray;
    }
    
    // フォーム名を取得する関数
    function getFormName() {
        // curlの例に合わせてフォーム名を設定
        return 'あたまの天気予報';
    }

    function calculateRiskPercentage() {
        let score = 0;
        const age = parseInt(formData.age, 10);
        if (age >= 85) score += 6;
        else if (age >= 75) score += 4;
        else if (age >= 65) score += 2;

        const bmi = formData.bmiValue || 0;
        if (bmi < 18.5) score += 1;
        else if (bmi >= 30) score += 2;
        else if (bmi >= 25) score += 1;

        for (const key in formData) {
            const question = questions.find(q => q.id === key);
            if (question && question.options) {
                const selectedOption = question.options.find(opt => opt.text === formData[key]);
                if (selectedOption) score += selectedOption.score;
            }
        }
        
        let riskPercent = (score * 0.9) + 0.5;
        riskPercent = Math.min(Math.max(riskPercent, 0.5), 60.0);
        
        return riskPercent.toFixed(1);
    }

    async function sendToGoogleSpreadsheet(formName, dataArray) {
        // Google Apps Script Web AppのURL
        const googleScriptURL = 'https://script.google.com/macros/s/AKfycbwamCcOjRaYG11Z_Pn9ZJP-ySE5CN1T9IIOBeCPOWJ6sii8TFfko1o_ZTljGrpMd6m0/exec';
        
        // 送信データをコンソールに出力（デバッグ用）
        console.log('=== データ送信開始 ===');
        console.log('フォーム名:', formName);
        console.log('送信するデータ配列:', dataArray);
        console.log('送信URL:', googleScriptURL);
        
        try {
            // ローディング表示
            showLoadingMessage('データを送信しています...');
            
            const requestData = {
                action: 'addData',
                formName: formName,
                data: dataArray
            };
            
            console.log('送信リクエストデータ:', JSON.stringify(requestData, null, 2));
            
            const response = await fetch(googleScriptURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(requestData)
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('=== データ送信成功 ===');
                console.log('サーバーレスポンス:', result);
                if (result.success) {
                    let message = `✅ 診断結果を正常に送信しました！\n\n`;
                    message += `📊 フォーム名: ${result.formName}\n`;
                    message += `📋 シート名: ${result.sheetName}\n`;
                    message += `📍 行番号: ${result.rowNumber}\n`;
                    message += `📈 総列数: ${result.totalColumns}\n`;
                    message += `⏰ 送信時刻: ${result.serverTimestamp}`;
                    
                    if (result.newColumns && result.newColumns.length > 0) {
                        message += `\n\n🆕 新しく追加された項目: ${result.newColumns.length}個`;
                        result.newColumns.forEach(col => {
                            message += `\n   • ${col.label} (${col.key})`;
                        });
                    }
                    
                    message += `\n\n📝 送信されたデータ項目数: ${dataArray.length}個`;
                    message += `\n💾 データはGoogleスプレッドシートに安全に保存されました。`;
                    
                    alert(message);
                } else {
                    throw new Error(result.message || '送信に失敗しました');
                }
            } else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('=== データ送信エラー ===');
            console.error('エラー詳細:', error);
            console.error('送信先URL:', googleScriptURL);
            console.error('送信データ:', dataArray);
            alert(`❌ データの送信に失敗しました。\n\n📋 エラー詳細: ${error.message}\n\n🔧 対処方法:\n• ネットワーク接続を確認してください\n• Google Apps Scriptのデプロイ状況を確認してください\n• ブラウザのコンソールで詳細なエラーログをご確認ください`);
        } finally {
            hideLoadingMessage();
        }
    }

    function showLoadingMessage(message) {
        // ローディングメッセージを表示する関数（必要に応じてカスタマイズ）
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-message';
        loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        loadingDiv.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span class="text-lg font-medium">${message}</span>
                </div>
            </div>
        `;
        document.body.appendChild(loadingDiv);
    }

    function hideLoadingMessage() {
        const loadingDiv = document.getElementById('loading-message');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
    }

</script>

</body>
</html>

